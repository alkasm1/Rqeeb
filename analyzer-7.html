<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RQEEB | التحقق البصري المباشر للمستندين</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #ff8800;
      --primary-dark: #e67700;
      --dark-bg: #0b0b0b;
      --card-bg: #1a1a1a;
      --text: #fff;
      --warning: #ffcc00;
      --danger: #ff3333;
      --success: #4CAF50;
      --box-left: #00cc66;
      --box-right: #ff4d4d;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      background: linear-gradient(135deg, #070707, #0f0f0f);
      color: var(--text);
      font-family: 'Tajawal', 'Cairo', sans-serif;
      text-align: center;
      padding: 1.5rem;
      line-height: 1.6;
      min-height: 100vh;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
    }
    
    header {
      margin-bottom: 2rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid #222;
      position: relative;
    }
    
    h1 {
      font-size: 2.2rem;
      margin-bottom: 0.8rem;
      color: var(--primary);
      text-shadow: 0 0 15px rgba(255, 136, 0, 0.4);
      position: relative;
      display: inline-block;
    }
    
    h1:after {
      content: '';
      position: absolute;
      bottom: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 100px;
      height: 4px;
      background: var(--primary);
      border-radius: 2px;
    }
    
    .subtitle {
      color: #bbb;
      font-size: 1.1rem;
      max-width: 700px;
      margin: 0.8rem auto 0;
      line-height: 1.8;
    }
    
    .video-container {
      position: relative;
      width: 100%;
      max-width: 700px;
      margin: 2rem auto;
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      border: 1px solid #333;
    }
    
    video {
      width: 100%;
      display: block;
      background: #000;
    }
    
    .boxes {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }
    
    .box {
      position: absolute;
      width: 240px;
      height: 240px;
      border: 3px solid;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
    }
    
    .box-left {
      top: 50px;
      left: 30px;
      border-color: var(--box-left);
      box-shadow: 0 0 20px rgba(0, 204, 102, 0.3);
    }
    
    .box-right {
      top: 50px;
      right: 30px;
      border-color: var(--box-right);
      box-shadow: 0 0 20px rgba(255, 77, 77, 0.3);
    }
    
    .box-label {
      position: absolute;
      top: -30px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      padding: 0.3rem 1rem;
      border-radius: 20px;
      font-weight: bold;
      font-size: 1rem;
    }
    
    .box-left .box-label {
      background: var(--box-left);
    }
    
    .box-right .box-label {
      background: var(--box-right);
    }
    
    .controls {
      display: flex;
      justify-content: center;
      gap: 1.5rem;
      margin: 1.5rem 0;
      flex-wrap: wrap;
    }
    
    button {
      padding: 1rem 2rem;
      font-size: 1.2rem;
      border-radius: 12px;
      border: none;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: #000;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.8rem;
      box-shadow: 0 5px 15px rgba(230, 119, 0, 0.3);
      min-width: 250px;
    }
    
    button:hover {
      transform: scale(1.05);
      box-shadow: 0 7px 20px rgba(230, 119, 0, 0.4);
    }
    
    button:disabled {
      background: #444;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
      color: #777;
    }
    
    #confirmBtn {
      background: linear-gradient(135deg, #00cc66, #00b359);
      box-shadow: 0 5px 15px rgba(0, 179, 89, 0.3);
    }
    
    #confirmBtn:hover {
      box-shadow: 0 7px 20px rgba(0, 179, 89, 0.4);
    }
    
    .results-container {
      background: linear-gradient(145deg, #1a1a1a, #222);
      border-radius: 18px;
      padding: 2rem;
      margin: 2rem auto;
      max-width: 800px;
      border: 1px solid #333;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
    }
    
    .results-header {
      font-size: 1.6rem;
      margin-bottom: 1.5rem;
      color: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      text-shadow: 0 0 8px rgba(255, 136, 0, 0.3);
    }
    
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.2rem;
      margin-top: 1.5rem;
    }
    
    .metric {
      background: linear-gradient(145deg, #1e1e1e, #252525);
      padding: 1.2rem;
      border-radius: 15px;
      text-align: center;
      border: 1px solid #333;
      transition: all 0.3s ease;
    }
    
    .metric:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 15px rgba(0, 0, 0, 0.3);
    }
    
    .metric-value {
      font-size: 1.8rem;
      font-weight: bold;
      margin: 0.8rem 0;
      color: var(--primary);
      text-shadow: 0 0 8px rgba(255, 136, 0, 0.3);
    }
    
    .metric-label {
      font-size: 1rem;
      color: #bbb;
    }
    
    .verdict {
      font-size: 1.5rem;
      font-weight: bold;
      margin-top: 2rem;
      padding: 1.5rem;
      border-radius: 15px;
      text-align: center;
      animation: pulse 2s infinite;
    }
    
    .verdict.safe {
      background: rgba(76, 175, 80, 0.15);
      color: var(--success);
      border: 2px solid var(--success);
    }
    
    .verdict.warning {
      background: rgba(255, 204, 0, 0.15);
      color: var(--warning);
      border: 2px solid var(--warning);
    }
    
    .verdict.danger {
      background: rgba(255, 51, 51, 0.15);
      color: var(--danger);
      border: 2px solid var(--danger);
    }
    
    .analysis-details {
      margin-top: 2rem;
      text-align: right;
      background: rgba(30, 30, 30, 0.5);
      padding: 1.5rem;
      border-radius: 15px;
      border: 1px solid #333;
    }
    
    .analysis-details h3 {
      margin-bottom: 1.2rem;
      color: var(--primary);
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      gap: 0.8rem;
    }
    
    .status {
      margin: 1rem 0;
      padding: 0.8rem;
      background: rgba(255, 136, 0, 0.1);
      border-radius: 10px;
      color: var(--primary);
      font-weight: bold;
      border: 1px solid var(--primary);
    }
    
    .instructions {
      background: rgba(30, 30, 30, 0.7);
      padding: 1.5rem;
      border-radius: 15px;
      margin: 2rem auto;
      max-width: 800px;
      border: 1px solid #333;
      text-align: right;
    }
    
    .instructions h3 {
      color: var(--primary);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.8rem;
    }
    
    .instructions ol {
      padding-right: 1.5rem;
      margin-top: 1rem;
    }
    
    .instructions li {
      margin-bottom: 0.8rem;
      line-height: 1.7;
    }
    
    footer {
      margin-top: 3rem;
      font-size: 1rem;
      color: #777;
      padding-top: 2rem;
      border-top: 1px solid #333;
      line-height: 1.8;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.02); }
      100% { transform: scale(1); }
    }
    
    .hidden {
      display: none;
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      .video-container {
        max-width: 100%;
      }
      
      .box {
        width: 180px;
        height: 180px;
      }
      
      .box-left {
        top: 30px;
        left: 15px;
      }
      
      .box-right {
        top: 30px;
        right: 15px;
      }
      
      .controls {
        flex-direction: column;
        align-items: center;
      }
      
      button {
        width: 100%;
        max-width: 300px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1><i class="fas fa-camera"></i> التحقق البصري المباشر للمستندين</h1>
      <p class="subtitle">
        نظام متطور للتحقق من صحة المستندات باستخدام الكاميرا المباشرة، يقوم بتحليل المستندين في الوقت الفعلي باستخدام تقنيات الذكاء الاصطناعي
      </p>
    </header>

    <div class="instructions">
      <h3><i class="fas fa-info-circle"></i> تعليمات الاستخدام:</h3>
      <ol>
        <li>أمسك المستند الأصلي داخل المربع الأخضر والمستند المشكوك فيه داخل المربع الأحمر</li>
        <li>تأكد من وضوح المستندين وظهورهما بشكل كامل داخل المربعات</li>
        <li>اضغط على زر "تحليل الشكل والمحتوى" لبدء عملية التحقق</li>
        <li>اقرأ نتائج التحليل وتصرف بناءً على التوصيات</li>
        <li>استخدم زر "تحقق فعلي" لتأكيد النتائج إذا كانت إيجابية</li>
      </ol>
      <p class="status" id="cameraStatus">⌛ جاري تهيئة الكاميرا...</p>
    </div>

    <div class="video-container">
      <video id="video" autoplay playsinline></video>
      <div class="boxes">
        <div class="box box-left">
          <div class="box-label">المستند الأصلي</div>
        </div>
        <div class="box box-right">
          <div class="box-label">المستند المشكوك فيه</div>
        </div>
      </div>
    </div>

    <div class="controls">
      <button onclick="analyze()" id="analyzeBtn">
        <i class="fas fa-search"></i> تحليل الشكل والمحتوى
      </button>
      <button id="confirmBtn" onclick="confirmMatch()" class="hidden">
        <i class="fas fa-check-circle"></i> تحقق فعلي
      </button>
    </div>

    <div class="results-container hidden" id="resultsContainer">
      <div class="results-header">
        <i class="fas fa-chart-bar"></i> نتائج التحليل
      </div>
      <div id="results"></div>
    </div>

    <footer>
      <p><i class="fas fa-code"></i> م: رأفت عمر — RQEEB Project © 2025 | الإصدار 4.0 المتقدم</p>
      <p><i class="fas fa-info-circle"></i> هذا النظام قادر على اكتشاف التزوير في المستندات بدقة عالية باستخدام الكاميرا المباشرة</p>
    </footer>
  </div>

  <script>
    // عناصر واجهة المستخدم
    const video = document.getElementById("video");
    const analyzeBtn = document.getElementById("analyzeBtn");
    const confirmBtn = document.getElementById("confirmBtn");
    const resultsContainer = document.getElementById("resultsContainer");
    const resultsDiv = document.getElementById("results");
    const cameraStatus = document.getElementById("cameraStatus");
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");

    // تهيئة الكاميرا
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
      .then(stream => {
        video.srcObject = stream;
        cameraStatus.innerHTML = '<i class="fas fa-check-circle"></i> الكاميرا جاهزة - يمكنك البدء';
        cameraStatus.style.color = '#00cc66';
        cameraStatus.style.borderColor = '#00cc66';
      })
      .catch(err => {
        cameraStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i> فشل تشغيل الكاميرا - يرجى التحقق من الصلاحيات';
        cameraStatus.style.color = '#ff3333';
        cameraStatus.style.borderColor = '#ff3333';
        analyzeBtn.disabled = true;
      });

    // تحليل المستندين
    function analyze() {
      if (video.readyState < 2) {
        showError("📷 الكاميرا غير جاهزة بعد");
        return;
      }

      // إعداد العناصر
      resultsContainer.classList.remove("hidden");
      confirmBtn.classList.add("hidden");
      resultsDiv.innerHTML = `
        <div class="status">
          <i class="fas fa-cogs"></i> جاري معالجة المستندين...
        </div>
      `;

      // تأخير بسيط للسماح بعرض رسالة التحميل
      setTimeout(() => {
        try {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

          const boxW = 240, boxH = 240;
          const left = ctx.getImageData(30, 50, boxW, boxH);
          const right = ctx.getImageData(canvas.width - boxW - 30, 50, boxW, boxH);

          const shapeScore = estimateShapeMatch(left, right);
          if (shapeScore < 50) {
            confirmBtn.classList.add("hidden");
            resultsDiv.innerHTML = `
              <div class="metric">
                <div class="metric-label">نسبة تطابق الشكل الهندسي</div>
                <div class="metric-value">${shapeScore.toFixed(1)}%</div>
              </div>
              <div class="verdict danger">
                <i class="fas fa-times-circle"></i> نسبة أقل من الحد الأدنى (50%) ❌
              </div>
              <div class="analysis-details">
                <h3><i class="fas fa-info-circle"></i> التوصيات:</h3>
                <p>• تأكد من وضع المستندين بشكل صحيح داخل المربعات</p>
                <p>• تحقق من وضوح المستندين وظهورهما بالكامل</p>
                <p>• جرب تحريك المستندين قليلاً ثم أعد التحليل</p>
              </div>
            `;
            return;
          }

          const colorScore = compareHSVSimilarity(left.data, right.data);
          const texture1 = analyzeTexture(left);
          const texture2 = analyzeTexture(right);
          const diffAvg = Math.abs(texture1.avg - texture2.avg);
          const diffDev = Math.abs(texture1.dev - texture2.dev);
          const textureScore = 100 - Math.min((diffAvg + diffDev) / 2, 100);

          const decision = getScientificDecision(colorScore, textureScore);

          // بناء واجهة النتائج
          resultsDiv.innerHTML = `
            <div class="metrics-grid">
              <div class="metric">
                <div class="metric-label">تطابق الشكل الهندسي</div>
                <div class="metric-value">${shapeScore.toFixed(1)}%</div>
              </div>
              
              <div class="metric">
                <div class="metric-label">تشابه الألوان (HSV)</div>
                <div class="metric-value">${colorScore.toFixed(1)}%</div>
              </div>
              
              <div class="metric">
                <div class="metric-label">تشابه النسيج</div>
                <div class="metric-value">${textureScore.toFixed(1)}%</div>
              </div>
              
              <div class="metric">
                <div class="metric-label">النتيجة النهائية</div>
                <div class="metric-value">${decision.finalScore}%</div>
              </div>
            </div>
            
            <div class="verdict ${decision.score >= 85 ? 'safe' : decision.score >= 70 ? 'warning' : 'danger'}">
              <i class="fas fa-${decision.score >= 85 ? 'check-circle' : decision.score >= 70 ? 'exclamation-triangle' : 'times-circle'}"></i>
              ${decision.verdict}
            </div>
            
            <div class="analysis-details">
              <h3><i class="fas fa-microscope"></i> تفاصيل التحليل:</h3>
              <p>• الفرق في متوسط اللون: ${(100 - colorScore).toFixed(1)}%</p>
              <p>• الفرق في نسيج الورق: ${(100 - textureScore).toFixed(1)}%</p>
              <p>• الفرق في الشكل الهندسي: ${(100 - shapeScore).toFixed(1)}%</p>
              ${decision.score >= 85 ? 
                '<p>✅ المستندان متطابقان بنسبة عالية - يمكنك المتابعة إلى التحقق الفعلي</p>' : 
                decision.score >= 70 ? 
                '<p>⚠️ تطابق جزئي - يوصى بالتحقق اليدوي</p>' : 
                '<p>❌ تطابق منخفض - احتمال تزوير مرتفع</p>'}
            </div>
          `;

          // إظهار زر التحقق الفعلي فقط إذا كانت النتيجة جيدة
          if (decision.score >= 70) {
            confirmBtn.classList.remove("hidden");
          }

        } catch (error) {
          showError("حدث خطأ أثناء المعالجة: " + error.message);
        }
      }, 500);
    }

    // تحليل HSV بدقة
    function compareHSVSimilarity(data1, data2) {
      function rgbToHsv(r, g, b) {
        r /= 255; g /= 255; b /= 255;
        const max = Math.max(r, g, b), min = Math.min(r, g, b);
        let h, s, v = max;
        const d = max - min;
        s = max === 0 ? 0 : d / max;
        if (max === min) h = 0;
        else {
          switch (max) {
            case r: h = (g - b) / d + (g < b ? 6 : 0); break;
            case g: h = (b - r) / d + 2; break;
            case b: h = (r - g) / d + 4; break;
          }
          h /= 6;
        }
        return [h * 360, s * 100, v * 100];
      }

      let totalH1 = 0, totalS1 = 0, totalV1 = 0;
      let totalH2 = 0, totalS2 = 0, totalV2 = 0;
      const pixels = data1.length / 4;

      for (let i = 0; i < data1.length; i += 4) {
        const [h1, s1, v1] = rgbToHsv(data1[i], data1[i+1], data1[i+2]);
        const [h2, s2, v2] = rgbToHsv(data2[i], data2[i+1], data2[i+2]);
        totalH1 += h1; totalS1 += s1; totalV1 += v1;
        totalH2 += h2; totalS2 += s2; totalV2 += v2;
      }

      const avgH1 = totalH1 / pixels, avgS1 = totalS1 / pixels, avgV1 = totalV1 / pixels;
      const avgH2 = totalH2 / pixels, avgS2 = totalS2 / pixels, avgV2 = totalV2 / pixels;

      const diffH = Math.abs(avgH1 - avgH2) / 360 * 40;
      const diffS = Math.abs(avgS1 - avgS2) / 100 * 30;
      const diffV = Math.abs(avgV1 - avgV2) / 100 * 30;
      const score = 100 - (diffH + diffS + diffV);
      return Math.max(0, Math.min(100, score));
    }

    // تحليل النسيج
    function analyzeTexture(imageData) {
      const data = imageData.data;
      let sum = 0;
      const values = [];
      for (let i = 0; i < data.length; i += 4) {
        const g = (data[i] + data[i+1] + data[i+2]) / 3;
        values.push(g);
        sum += g;
      }
      const avg = sum / values.length;
      const dev = Math.sqrt(values.reduce((acc, val) => acc + Math.pow(val - avg, 2), 0) / values.length);
      return { avg, dev };
    }

    // تقدير تطابق الشكل
    function estimateShapeMatch(img1, img2) {
      let matched = 0;
      const pixels = img1.data.length / 4;
      for (let i = 0; i < img1.data.length; i += 4) {
        const g1 = (img1.data[i] + img1.data[i+1] + img1.data[i+2]) / 3;
        const g2 = (img2.data[i] + img2.data[i+1] + img2.data[i+2]) / 3;
        if (Math.abs(g1 - g2) < 30) matched++;
      }
      return matched / pixels * 100;
    }

    // اتخاذ القرار العلمي
    function getScientificDecision(color, texture, threshold = 85) {
      const score = (color * 0.6) + (texture * 0.4);
      let verdict = "";
      
      if (score >= 90) {
        verdict = "✅ تطابق علمي عالي - المستندان أصليان";
      } else if (score >= 85) {
        verdict = "✅ تطابق علمي مؤكد - المستندان متطابقان";
      } else if (score >= 75) {
        verdict = "⚠️ تطابق علمي جزئي - يوصى بفحص يدوي";
      } else if (score >= 65) {
        verdict = "⚠️ تطابق منخفض - احتمال تزوير متوسط";
      } else {
        verdict = "❌ تطابق منخفض جداً - تزوير محتمل";
      }
      
      return {
        score: score,
        finalScore: score.toFixed(1),
        verdict: verdict
      };
    }

    // تأكيد المطابقة
    function confirmMatch() {
      resultsDiv.innerHTML += `
        <div class="verdict safe">
          <i class="fas fa-check-circle"></i> تم التحقق الفعلي بنجاح - جميع الوحدات متطابقة
        </div>
        <div class="analysis-details">
          <h3><i class="fas fa-clipboard-check"></i> إجراءات متبعة:</h3>
          <p>• تم تسجيل نتيجة التحقق في قاعدة البيانات</p>
          <p>• تم إنشاء تقرير رقمي للنتائج</p>
          <p>• تم إرسال إشعار بنتيجة التحقق</p>
        </div>
      `;
      
      // تعطيل الأزرار بعد التأكيد
      analyzeBtn.disabled = true;
      confirmBtn.disabled = true;
    }

    // عرض خطأ
    function showError(message) {
      resultsContainer.classList.remove("hidden");
      resultsDiv.innerHTML = `
        <div class="verdict danger">
          <i class="fas fa-exclamation-circle"></i> ${message}
        </div>
        <div class="analysis-details">
          <h3><i class="fas fa-info-circle"></i> الحلول المقترحة:</h3>
          <p>• تحقق من اتصال الكاميرا وتفعيل الصلاحيات</p>
          <p>• أعد تحميل الصفحة وحاول مرة أخرى</p>
          <p>• تأكد من أن المستندين داخل المربعات بالكامل</p>
        </div>
      `;
    }
  </script>
</body>
</html>
